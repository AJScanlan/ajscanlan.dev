---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import {
    ARCHIVE_COLLECTIONS,
    ARCHIVE_LABELS,
    type ArchiveCollection,
    type ArchiveEntryData,
    getPrimaryDate,
} from "@/lib/archive";

const entries: Array<{
    collection: ArchiveCollection;
    slug: string;
    data: ArchiveEntryData;
}> = (
    await Promise.all(
        ARCHIVE_COLLECTIONS.map(async (collection) => {
            const items = await getCollection(
                collection,
                ({ data }) => data.status === "published",
            );
            return items.map((item) => ({
                collection,
                slug: item.slug,
                data: item.data as ArchiveEntryData,
            }));
        }),
    )
).flat();

const orderedEntries = entries
    .slice()
    .sort((a, b) => {
        const aDate = getPrimaryDate(a.data)?.valueOf() ?? 0;
        const bDate = getPrimaryDate(b.data)?.valueOf() ?? 0;
        return bDate - aDate;
    });
---

<BaseLayout title="Archive - ajscanlan.dev">
    <h1 class="text-2xl font-semibold mb-6">Archive</h1>
    <ul class="space-y-4">
        {
            orderedEntries.map(({ collection, data, slug }) => {
                const displayDate = getPrimaryDate(data);
                return (
                    <li>
                        <span class="text-xs uppercase tracking-wide text-ink-500 dark:text-ink-400">
                            {ARCHIVE_LABELS[collection]}
                        </span>
                        <a
                            href={`/archive/${collection}/${slug}/`}
                            class="block hover:underline"
                        >
                            {data.title}
                        </a>
                        {displayDate && (
                            <span class="text-ink-500 text-sm">
                                {" "}
                                Â· {displayDate.toLocaleDateString("en-IE")}
                            </span>
                        )}
                        {data.dek && (
                            <p class="text-ink-600 dark:text-ink-400 text-sm">
                                {data.dek}
                            </p>
                        )}
                    </li>
                );
            })
        }
    </ul>
</BaseLayout>
