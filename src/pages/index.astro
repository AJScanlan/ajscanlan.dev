---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import {
	ARCHIVE_COLLECTIONS,
	ARCHIVE_LABELS,
	type ArchiveEntryData,
	type ArchiveCollection,
	getPrimaryDate,
} from "@/lib/archive";

const aggregatedEntries: Array<{
	collection: ArchiveCollection;
	slug: string;
	data: ArchiveEntryData;
}> = (
	await Promise.all(
		ARCHIVE_COLLECTIONS.map(async (collection) => {
			const items = await getCollection(
				collection,
				({ data }) => data.status === "published",
			);
			return items.map((item) => ({
				collection,
				slug: item.slug,
				data: item.data as ArchiveEntryData,
			}));
		}),
	)
)
	.flat()
	.sort((a, b) => {
		const aDate = getPrimaryDate(a.data)?.valueOf() ?? 0;
		const bDate = getPrimaryDate(b.data)?.valueOf() ?? 0;
		return bDate - aDate;
	})
	.slice(0, 8);
---

<BaseLayout
	title="ajscanlan.dev"
	description="Writing my way to understanding."
>
	<section class="mb-12">
		<h1 class="text-3xl font-semibold tracking-tight mb-3">
			Writing my way to understanding
		</h1>
		<p class="text-ink-700 dark:text-ink-200 max-w-prose">
			Short, sincere, approachable reflections â€” clarity over flair.
			Occasionally technical, often humane.
		</p>
	</section>

	<section>
		<h2 class="text-xl font-semibold mb-4">Latest writing</h2>
		<ul class="space-y-5">
			{
				aggregatedEntries.map(({ collection, data, slug }) => {
					const displayDate = getPrimaryDate(data);
					return (
						<li>
							<span class="text-xs uppercase tracking-wide text-ink-700 dark:text-ink-200">
								{ARCHIVE_LABELS[collection]}
							</span>
							<a href={`/archive/${collection}/${slug}/`} class="block">
								<h3 class="text-lg font-medium hover:underline">
									{data.title}
								</h3>
								{data.dek && (
									<p class="text-sm text-ink-700 dark:text-ink-200">
										{data.dek}
									</p>
								)}
								{displayDate && (
									<time class="text-xs text-ink-700 dark:text-ink-100">
										{displayDate.toLocaleDateString("en-IE", {
											year: "numeric",
											month: "short",
											day: "2-digit",
										})}
									</time>
								)}
							</a>
						</li>
					);
				})
			}
		</ul>
	</section>
</BaseLayout>
